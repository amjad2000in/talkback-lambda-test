# Talkback Clean


```bash
.
├── README.md                   <-- This instructions file
├── event.json                  <-- API Gateway Proxy Integration event payload
├── talkback_clean              <-- Source code for a lambda function
│   ├── __init__.py
│   ├── app.py                  <-- All of the Lambda function code
│   ├── requirements.txt        <-- Requirements file from `pip freeze`
├── template.yaml               <-- SAM Template
└── tests                       <-- Unit tests
    └── unit
        ├── __init__.py
        └── test_handler.py
        └── test_cmdline.py     <-- Right-click | Run
```

## Requirements

* AWS CLI already configured with talkback profile
* [Python 3 installed](https://www.python.org/downloads/)
* (venv) `pip install -e ../tbproject` Development reference to TBProject class
* Close and re-open project so Pycharm re-indexes packages following `pip install -e`

## Setup process

### Local development

**Invoking function locally without docker or API Gateway (recommended)**

```bash
tests/unit/test_cmdline.py
```

**Invoking function locally using a local sample payload**

```bash
sam local invoke TBCleanFunction --event event.json
```

**Invoking function locally through local API Gateway**

```bash
sam local start-api
```

If the previous command ran successfully you should now be able to hit the following local endpoint to invoke your function `http://localhost:3000/talkback_clean`

**SAM CLI** is used to emulate both Lambda and API Gateway locally and uses our `template.yaml` to understand how to bootstrap this environment (runtime, where the source code is, etc.) - The following excerpt is what the CLI will read in order to initialize an API and its routes:

```yaml
...
Events:
    TBClean:
        Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
        Properties:
            Path: /talkback_clean
            Method: get
```

## Packaging and deployment

AWS Lambda Python runtime requires a flat folder with all dependencies including the application. SAM will use `CodeUri` property to know where to look up for both application and dependencies:

```yaml
...
    TBCleanFunction:
        Type: AWS::Serverless::Function
        Properties:
            CodeUri: talkback_clean/
            ...
```

Firstly, we need a `S3 bucket` where we can upload our Lambda functions packaged as ZIP before we deploy anything - If you don't have a S3 bucket to store code artifacts then this is a good time to create one:

```bash
aws s3 --profile talkback --region us-east-1 mb s3://talkback-lambda
```

Next, validate the sam template

```bash
sam validate --profile talkback --region us-east-1 --template template.yaml
```

Next, update the requirements file from within (venv)

Within Pycharm use the Terminal
```bash
(venv) pip freeze > talkback_clean/requirements.txt
```

Or from the command line

```bash
cd tbclean
source venv/bin/activate
(venv) pip freeze > talkback_clean/requirements.txt
deactivate 
```

The sam commands below should not be run in (venv)

Next, build the zip archive. 


```bash
sam build --profile talkback --region us-east-1 --debug
```

Next, run the following command to package our Lambda function to S3:

```bash
sam package --profile talkback --region us-east-1 \
    --output-template-file packaged.yaml \
    --s3-bucket talkback-lambda
```

Next, the following command will create a Cloudformation Stack and deploy your SAM resources.

```bash
sam deploy --profile talkback --region us-east-1 \
    --template-file packaged.yaml \
    --stack-name tbclean \
    --capabilities CAPABILITY_IAM
```

> **See [Serverless Application Model (SAM) HOWTO Guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-quick-start.html) for more details in how to get started.**

After deployment is complete you can run the following command to retrieve the API Gateway Endpoint URL:

```bash
aws cloudformation describe-stacks \
    --stack-name tbclean \
    --query 'Stacks[].Outputs[?OutputKey==`TBCleanApi`]' \
    --output table
``` 

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called sam logs. sam logs lets you fetch logs generated by your Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
sam logs --profile talkback --region us-east-1 -n TBCleanFunction --stack-name tbclean --tail
```

You can find more information and examples about filtering Lambda function logs in the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).

## Testing


Next, we install test dependencies and we run `pytest` against our `tests` folder to run our initial unit tests:

```bash
pip install pytest pytest-mock --user
python -m pytest tests/ -v
```

## Cleanup

Delete the stack

```bash
aws cloudformation --profile talkback --region us-east-1 delete-stack --stack-name tbclean
```

